#!/bin/bash -ex

export PATH=$PATH:`dirname $0`
cd `dirname $0`/../web/db

ssh_command="${SSH_ORIGINAL_COMMAND}"

if [ -z "${ssh_command}" ] ; then
  echo "SSH_ORIGINAL_COMMAND is not set. Please report this error to the sysadmin."
  exit 1;
fi

cmd=`echo "${ssh_command}" | grep '^git' | sed -e 's/\ .*//g' | sed -e 's/git.//g'`
if [[ "${cmd}" != "receive-pack" && "${cmd}" != "upload-pack" ]] ; then
  echo "Unauthorized command; aborting."
  exit 1;
fi

user_id="${1}"
repopath=`echo $ssh_command | sed -e 's/.* //g' -e s/\'//g`
if [ "${cmd}" = "receive-pack" ] ; then
  gitforest-checkpermissions "write" "${user_id}" "${repopath}"
elif [ "${cmd}" = "upload-pack" ] ; then
  gitforest-checkpermissions "read" "${user_id}" "${repopath}"
fi

cd `dirname $0`/../repos
echo "Executing $ssh_command"
#git shell -c "${ssh_command}"
