#!/bin/sh -e
#

sleep 1

root=`dirname $0`
keyfile="$HOME/.ssh/authorized_keys"
command="$root/gitforest-sshhandler"

echo "### Autogenerated ###" > $keyfile
echo "#" >> $keyfile
echo "# $command [user]" >> $keyfile
echo "# To find out what a username for a id is run usernamefromid [id]" >> $keyfile
echo "#" >> $keyfile

cd $root/../web/db
sqlite3 development.sqlite3 'select user_id,key from sshkeys' | while read row ; do
    user=`echo $row | awk -F'|' '{ print $1 }'`
    key=`echo $row | awk -F'|' '{ print $2 }'`
    if [ ! -z "${key}" ] ; then
        echo "command=\"$command $user\",no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty $key" >> $keyfile
    fi
done

# Make the file rw for this user only
chmod 0600 "${keyfile}"
