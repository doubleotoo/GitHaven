#!/bin/sh -e
#

sleep 1

root=`pwd`
if [ ! -d "${HOME}" ] ; then
  HOME="/var/git"
fi
keyfile="${HOME}/.ssh/authorized_keys"
command="githaven-sshhandler"

tempfile=`mktemp`

echo "### Autogenerated ###" > ${tempfile}
echo "#" >> ${tempfile}
echo "# $command [user]" >> ${tempfile}
echo "# To find out what a username for a id is run githaven-usernamefromid [id]" >> ${tempfile}
echo "#" >> ${tempfile}

cd ${root}/db
dbfile=`githaven-db`
sqlite3 "${dbfile}" 'select user_id,key from sshkeys' | while read row ; do
    user=`echo $row | awk -F'|' '{ print $1 }'`
    key=`echo $row | awk -F'|' '{ print $2 }'`
    if [ ! -z "${key}" ] ; then
        echo "command=\"${command} ${user}\",no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty "${key}"" >> $tempfile
    fi
done

mv -fu "${tempfile}" "${keyfile}"

# Make the file rw for this user only
chmod 0600 "${keyfile}"
